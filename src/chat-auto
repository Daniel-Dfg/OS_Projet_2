#!/usr/bin/env bash

set -e  # Arrête le script dès une erreur

# Vérifie les pseudonymes
function verify_pseudo() {
    local user_name="$1"
    local bot_name="$2"
    local max_length=6

    # Vérifie si les pseudonymes sont identiques
    if [[ "$user_name" == "$bot_name" ]]; then
        echo "Erreur : Vous ne pouvez pas avoir le même nom que votre destinataire :( " >&2
        return 1
    fi

    # Vérifie la longueur des pseudonymes
    if (( ${#user_name} > max_length || ${#bot_name} > max_length )); then
        echo "Erreur : Longueur du pseudo utilisateur/destinataire doit être inférieure ou égale à $max_length caractères" >&2
        return 1
    fi

    return 0
}

# Vérifie les arguments et renvoie les options
function verify_entry() {
    local user_name=""
    local receiver_name="bot"  # Valeur par défaut
    local mode1=""             
    local mode2=""             

    # Vérifie le nombre d'arguments
    if [[ $# -lt 1 || $# -gt 4 ]]; then 
        echo "Usage : ./chat utilisateur [--bot] [--manuel]" >&2
        exit 1
    fi

    user_name="$1"

    # Vérification des modes (3e et 4e arguments)
    if [[ $# -ge 2 ]]; then
        mode1="$2"
        if [[ "$mode1" != "--bot" && "$mode1" != "--manuel" ]]; then
            echo "Erreur : Le mode doit être --bot ou --manuel" >&2
            exit 1
        fi
    fi
    if [[ $# -ge 3 ]]; then
        mode2="$3"
        if [[ "$mode2" != "--bot" && "$mode2" != "--manuel" || "$mode1" == "$mode2" ]]; then
            echo "Erreur : Les modes doivent être --bot ou --manuel et différents" >&2
            exit 1
        fi
    fi

    echo "$user_name $receiver_name $mode1 $mode2"
}

# Fonction principale de chat
function chat() {
    local user_name="$1"
    local receiver_name="$2"
    local mode1="$3"
    local mode2="$4"
    local chat_command="./chat $user_name"

    # Ajoute les options --bot et/ou --manuel si elles sont spécifiées
    if [[ -n "$mode1" ]]; then
        chat_command="$chat_command $mode1"
    fi
    if [[ -n "$mode2" ]]; then
        chat_command="$chat_command $mode2"
    fi

    # Demande initiale du pseudo destinataire
    while true; do
        echo "Entrez le pseudo du destinataire :" >&2
        if read -r new_user_name; then
            if verify_pseudo "$new_user_name" "$user_name"; then
                receiver_name="$new_user_name"
                break
            else
                echo "Pseudo invalide. Réessayez" >&2
            fi
        else
            echo "Fermeture du programme" >&2
            exit 0
        fi
    done
    # Boucle principale
    echo "Appuyez sur Ctrl+D pour changer de destinataire" >&2
    
    while true; do
        if read -r user_message; then
            # Envoie le message avec le pseudo
            echo "$receiver_name $user_message"
        else
            # Si Ctrl+D détecté
            echo "Entrez un nouveau pseudo destinataire :" >&2
            if read -r new_user_name; then
                if verify_pseudo "$new_user_name" "$user_name"; then
                    receiver_name="$new_user_name"
                    echo "Le destinataire est : $receiver_name" >&2
                else
                    echo "Pseudo invalide, le destinataire reste le même" >&2
                fi
            else
                echo "Deux Ctrl+D détectés, fermeture du programme" >&2
                break
            fi
        fi
    done | $chat_command
}

# Fonction principale
function main() {
    local user_name receiver_name mode1 mode2
    read -r user_name receiver_name mode1 mode2 < <(verify_entry "$@")
    chat "$user_name" "$receiver_name" "$mode1" "$mode2"
}

main "$@"
